<%= render "shared/modal",
           modal_id: "newPlaylistModal",
           title: "Nouvelle playlist",
           buttons: [
             # Bouton Créer la playlist
             button_tag("Créer la playlist",
                        type: "submit",
                        form: "new_portfolio_form",
                        style: "
                          display: inline-block;
                          border: 2px solid #fff;
                          background: #fff;
                          color: #000;
                          padding: 10px 20px;
                          font-size: 1rem;
                          font-weight: 500;
                          cursor: pointer;
                          transition: transform 0.2s ease-in-out;
                          border-radius: 75px;
                          text-decoration: none;
                        ",
                        onmouseover: "this.style.transform='scale(1.05)';",
                        onmouseout: "this.style.transform='scale(1)';"
             )
           ] do %>

  <%= form_with model: @portfolio,
                url: portfolios_path,
                method: :post,
                html: { id: "new_portfolio_form", multipart: true },
                local: true do |f| %>

    <!-- Affichage des erreurs (si l’utilisateur soumet un formulaire incomplet) -->
    <% if f.object.errors.any? %>
      <div style="color: #ff5555; margin-bottom: 1rem;">
        <% f.object.errors.full_messages.each do |msg| %>
          <p style="margin:0;"><%= msg %></p>
        <% end %>
      </div>
    <% end %>

<!-- Champ Photo avec zone d'upload personnalisée -->
    <div class="mb-3">
      <%= f.label :photo, "Bannière", class: "form-label" %>
      <div id="createBannerContainer"
           style="
             position: relative;
             width: 150px;
             height: 150px;
             margin-bottom: 1rem;
             border: 2px dashed #ccc;
             border-radius: 1rem;
             background: rgba(255,255,255,0.1);
             cursor: pointer;
             transition: border-color 0.2s, background 0.2s;
           "
           onmouseover="
             this.style.borderColor = '#fff';
             this.style.background = 'rgba(255,255,255,0.2)';
           "
           onmouseout="
             this.style.borderColor = '#ccc';
             this.style.background = 'rgba(255,255,255,0.1)';
           "
           onclick="document.getElementById('createPhotoInput').click()">
        <i id="createIconImage"
           data-lucide="image"
           style="
             position: absolute;
             top: 50%;
             left: 50%;
             transform: translate(-50%,-50%);
             width: 24px;
             height: 24px;
             color: #aaa;
           ">
        </i>
        <img id="createPhotoPreview"
             style="
               display: none;
               width: 100%;
               height: 100%;
               object-fit: cover;
               border-radius: 1rem;
             " />
      </div>
      <% if f.object.errors[:photo].present? %>
        <div style="color: #ff5555; font-size: 0.9rem;">
          <%= f.object.errors[:photo].join(", ") %>
        </div>
      <% end %>
    </div>

    <!-- Champ file caché -->
    <%= f.file_field :photo,
                     id: "photoInputNew",
                     style: "display: none;",
                     onchange: "updatePhotoPreviewNew(this)" %>

    <!-- TITRE DE LA PLAYLIST -->
    <div class="mb-3">
      <%= f.label :title, "Titre de la playlist", class: "form-label" %>
      <%= f.text_field :title, class: "form-control" %>
    </div>

    <!-- GENRE -->
    <div class="mb-3">
      <%= f.label :tags, "Genre", class: "form-label" %>
      <%= f.select :tags,
                   Portfolio::TAG_OPTIONS,
                   { prompt: "Choisissez un genre" },
                   class: "form-select" %>
    </div>

  <% end %>

  <!-- Script : preview + overlay + reset form -->
  <script>
    function updatePhotoPreviewNew(input) {
      const preview = document.getElementById("photoPreviewNew");
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          preview.src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    document.addEventListener("turbo:load", function() {
      const modal = document.getElementById("newPlaylistModal");
      if (!modal) return;

      let formSubmitted = false;
      const form = document.getElementById("new_portfolio_form");
      if (form) {
        form.addEventListener("submit", function() {
          formSubmitted = true;
        });
      }

      // Survol => on affiche l’overlay
      const container = document.getElementById("banner-container-new");
      const overlay = container.querySelector(".overlay");
      container.addEventListener("mouseenter", function() {
        overlay.style.display = "flex";
        overlay.style.opacity = 1;
      });
      container.addEventListener("mouseleave", function() {
        overlay.style.opacity = 0;
        setTimeout(function() {
          overlay.style.display = "none";
        }, 200);
      });

      // Reset si on ferme la modal sans soumettre
      modal.addEventListener("hidden.bs.modal", function() {
        if (!formSubmitted && form) {
          form.reset();
        }
        // Remettre l’image par défaut
        const preview = document.getElementById("photoPreviewNew");
        if (preview) {
          preview.src = "/images/default.png"; // ou votre placeholder
        }
        formSubmitted = false;
      });
    });
  </script>
<% end %>
